<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Connexion Arduino Mega â†’ Google Sheets</title>
</head>

<body>
  <h1>Connexion Arduino Mega â†’ Google Sheets</h1>
  <button id="connect">Connecter l'Arduino</button>
  <button id="clear">Vider les donnÃ©es</button>
  <pre id="log"></pre>

  <script>
    let port;
    let reader;
    let buffer = "";

    const logEl = document.getElementById("log");

    // ðŸ‘‰ COLLE ICI ton URL Apps Script /exec
    const URL_SHEETS = "https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbxeufEh4RSPJE3ob4Cn0mQKn4YNcffmO8_q8kMdFHd91YHCQx5WXLbyga36MTl4wtD4/exec";

    // --- Connexion Ã  l'Arduino ---
    document.getElementById("connect").addEventListener("click", async () => {
      try {
        if (!("serial" in navigator)) {
          logEl.textContent += "Web Serial n'est pas supportÃ© dans ce navigateur.\n";
          return;
        }

        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        logEl.textContent += "Connexion rÃ©ussie.\n";

        const decoder = new TextDecoderStream();
        port.readable.pipeTo(decoder.writable);
        reader = decoder.readable.getReader();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (!value) continue;

          buffer += value;

          let lines = buffer.split("\n");
          buffer = lines.pop(); // garde la derniÃ¨re ligne incomplÃ¨te

          for (let line of lines) {
            traiterLigne(line.trim());
          }
        }
      } catch (err) {
        logEl.textContent += "\nErreur de lecture : " + err + "\n";
      }
    });

    // --- Bouton pour vider les donnÃ©es ---
    document.getElementById("clear").addEventListener("click", () => {
      if (!confirm("Effacer toutes les donnÃ©es (sauf l'en-tÃªte) ?")) return;

      fetch(URL_SHEETS + "?clear=1", { mode: "no-cors" })
        .then(() => {
          logEl.textContent += "\nRequÃªte d'effacement envoyÃ©e.\n";
        })
        .catch(err => {
          logEl.textContent += "\nErreur d'effacement : " + err + "\n";
        });
    });

    // --- Traitement d'une ligne CSV reÃ§ue ---
    function traiterLigne(line) {
      if (!line || line.startsWith("time_ms")) return;

      const parts = line.split(",");
      if (parts.length < 4) return;

      const timeMs   = Number(parts[0]);
      const timeSec  = Number(parts[1]);
      const rawValue = Number(parts[2]);
      const angleDeg = Number(parts[3]);

      // Affiche dans la console de la page
      logEl.textContent += line + "\n";

      // Envoie vers Google Sheets
      const url =
        URL_SHEETS +
        "?timeMs=" + encodeURIComponent(timeMs) +
        "&timeSec=" + encodeURIComponent(timeSec) +
        "&rawValue=" + encodeURIComponent(rawValue) +
        "&angleDeg=" + encodeURIComponent(angleDeg);

      fetch(url, { mode: "no-cors" }).catch(err => {
        logEl.textContent += "\nErreur d'envoi Sheets : " + err + "\n";
      });
    }
  </script>
</body>
</html>
