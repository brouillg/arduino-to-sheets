<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Connexion Arduino Mega â†’ Google Sheets</title>
</head>

<body>
  <h1>Connexion Arduino Mega â†’ Google Sheets</h1>

  <button id="connect">Connecter l'Arduino</button>
  <pre id="output"></pre>

  <script>
    // ðŸ”— Remplace TON_URL_ICI par ton URL de dÃ©ploiement Apps Script (type .../exec)
    const APP_URL = "https://script.google.com/macros/s/TON_URL_ICI/exec";

    let port;
    const output = document.getElementById("output");
    let buffer = "";

    document.getElementById("connect").addEventListener("click", async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });

        const reader = port.readable.getReader();

        output.textContent += "Connexion rÃ©ussie.\n\n";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          const text = new TextDecoder().decode(value);

          // On accumule le texte et on traite ligne par ligne
          buffer += text;
          const lines = buffer.split('\n');
          buffer = lines.pop(); // garde la derniÃ¨re ligne incomplÃ¨te

          for (let line of lines) {
            line = line.trim();
            if (!line) continue;

            // Affichage brut Ã  l'Ã©cran
            output.textContent += line + "\n";

            // Envoi vers Google Sheets
            handleLine(line);
          }
        }
      } catch (err) {
        output.textContent += "Erreur : " + err + "\n";
      }
    });

    function handleLine(line) {
      // On saute la ligne d'en-tÃªte
      if (line.startsWith("time_ms")) return;

      const parts = line.split(",");
      if (parts.length < 4) return;

      const timeMs   = Number(parts[0]);
      const timeSec  = Number(parts[1]);
      const rawValue = Number(parts[2]);
      const angleDeg = Number(parts[3]);

      // Envoi au script Google Apps Script
      fetch(APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          timeMs,
          timeSec,
          rawValue,
          angleDeg
        })
      });
    }
  </script>
</body>
</html>
